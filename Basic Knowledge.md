# 基于esp32c3的小键盘

## 引入

目标的痛点为：尽管现行的键盘方案上以快捷键的方式实现了音量调节、歌曲切换等功能，但往往与Fn功能键绑定，即最少需要同时摁两个键才能实现需求效果，但是Fn功能键与R4按键距离较远，一般需要两手操作，极其不便。

因此，设计一块迷你键盘，实现简单的切歌、音量调节功能。

市面上存在类似方案，但是做工粗糙，所以选择自行diy。

![友商产品](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\友商产品.jpg)

考虑到键盘体积较小，做有线连接会使得键盘的使用极其不便，丧失初衷，故选择以蓝牙连接，配备锂电池及相应的周边电路。

## 软件

ESP32C3有对应的arduino集成包，使得芯片能模拟为蓝牙键盘，并触发按键效果，其中包括音量、切歌等功能，故而在蓝牙协议、与电脑交互方面不需要考虑太多。

### 音量调节

首先需要明确一点为，音量的控制权不能全部交给蓝牙小键盘，其必然要同时受windows系统、正常使用的键盘控制，因此，蓝牙键盘的音量相关指令应为调节指令、而不是控制指令，即不设定具体音量值，而是采取音量加减的方式去调节音量。

### 功耗调节

ESP32C3提供了多种功耗模式的选择，纵然其全负荷运转的电流已经很低，但是为了使本项目的设计更加合理，会尝试在后期加入待机模式。

## 硬件

### 选型

#### 机械键盘

毫无疑问，青轴。

为了使整个键盘观感和手感俱佳，选取铝合金键帽。

#### 旋钮

用旋钮控制音量的方案其实是更人性化、也是很普遍接受的，因此本项目也使用该方法。

一开始的直观想法是用电位器，通过分压的方式去测量电位器阻值，而后做对应的操作，但是这个方案的问题在于，电位器在拧到头了之后就会存在失效的问题。

做了一定的检索后，得知旋转编码器的存在，其不仅能做到无停止位，而且直接输出数字信号，减少了很多软件层面的操作和调整。

具体型号为EC11，额外配铝合金旋钮。

![部分实物](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\部分实物.jpg)

#### 锂电池

在保证键盘体积的情况下，选取最大的容量，本项目选到3.7V锂电池，容量为3000毫安时。

锂电池的放电电压受电池剩余电量影响，存在正相关关系，往往能从5V到2V区间内变化，考虑到ESP32C3的工作电压为3.3V，故而该锂电池是完全能够供得起该芯片的。

另外要考虑的是充电问题，该锂电池的充电电流为1A-2A，电压为4.2V。虽说其自带保护板，但是仍在项目中为其配备了充电保护的芯片。

#### 外壳

铝合金，定制，在整个项目最后进行。

可能存在的问题：金属外壳屏蔽蓝牙信号。

#### 接口

顺应时代发展，用TYPE-C。

#### 其他芯片

CH340C：自带晶振的USB转串口芯片，以简单的电路完成ESP32C3的烧写工作。

AMS117-3.3V：降压芯片，输出电压为3.3V。

TP4056：锂电池充电保护芯片，带有充电指示灯的接口。

### 软硬件交互

#### 机械键盘

等效为一个开关，摁下导通。

但是需要考虑的是，轴体为了适应键盘矩阵，会内置一个单向导通的二极管，故而在绘制电路时需要考虑该二极管使得GPIO能正确读取摁键状态。

#### 旋转编码器

参照https://blog.csdn.net/MiKiJT/article/details/113542855。

其中，EC11还额外附带了一个类似摁键开关的功能，此项目中接入了核心芯片，但未分配功能。一个常见的操作方案为：摁下时旋钮控制另一个内容，此时旋钮用一个开关被扩展为了两个功能。

#### 电池电量

上文中提到锂电池输出电压与电池电量正相关，因此利用ESP32C3的模拟输入端口检测锂电池电压，而后将电量信息模拟为蓝牙键盘的电量，利用头文件中内置的功能发送到电脑，并且也可以用电路板上备用的LED做提示。

经实验有：

![电池电压特性曲线](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\电池电压特性曲线.png)

假定同时间内充入的电量相等，那么从图中看出，在正常工作区间内，电池电压总体上与剩余电量成线性关系。而考虑到本项目未配备升压电路，也就是说电池最低的输出电压应该保证在3.3V，故而可以等分电压区间来表征电池电量，合理提示电量不足和充电。

### 原理图绘制

![原理图概览](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\原理图概览.png)

参照各个开源项目的原理图综合绘制。

#### typec

其中，cc接口为typec对typec连接时用到，对该项目无关，后续的电阻理论上可以不焊。

D+和D-为两组差分信号，用以烧录芯片。

VBUS和GND做整个项目的供电。

#### 电源切换电路

需要实现的功能为插入typec时，用typec供电芯片，并同时为锂电池充电。反之，用锂电池供电。

核心其实是一个PMOS，通过typec的电压控制锂电池输出电路的导通与否。连接的二极管推测为防倒灌。

此时，顺便完成电池电压的模拟量测量。ESP32C3的模拟量测量范围为0-3.3V，而且在两端会有极大误差，故而做了一个分压的操作，此时测得的模拟量范围大致为1.5V-2.5V，在最佳范围内。

还加入了一个拨码开关，作为整个键盘的总开关。

#### 锂电池充电电路

上文提到锂电池有4.2V的充电电压限制，故而先防止一个电阻在电源输入处，具体阻值需要后续实际调整。

芯片会自行输出当前工作状态的数字量，用以控制LED灯珠。

其中，PROG脚后的电阻用以控制充电电流，但是TP4056的最大输出电流为1A，完全在锂电池允许范围内，故而不需要多余的顾虑。

#### 降压电路

套路似的设计方案，极为成熟，不需要多余的调整。

#### typec转串口

不会，照着画的。

#### 自动下载电路

对于芯片来说，一般的下载方法是通过摁键使得特定IO有特定电平后进入下载模式，但是成熟的开发板和对应的转串口芯片会自动调节IO电平使得芯片进入下载模式并复位，但是电路看不懂。

#### 核心及周边

没什么可说的，将外设连到芯片上。

### PCB绘制

以以下的几条为指导思想：

- 元器件排放整齐、紧密、有规律。
- 对应接口的滤波电容、上下拉电阻等就近放置。
- 电源线尽量不走通孔，在单层直连。
- 差分信号线尽量不走通孔，在单层直连。
- 地线以敷铜的方式在第二层完成，符合一般行业风格。

需要注意的几点是：

ESP32C3的芯片自带天线，为防治电磁干扰，部分设计方案选择挖空天线下方的PCB，本项目沿用此方法。同时，在挖空的交界处会开一排对地的通孔，怀疑是同样的功能，依旧照做。

为使得实际成品较为舒服，将旋钮和键盘放在PCB反面，其余元器件放在PCB正面，便于后期的种种工作。

排母只为了在PCB上开等间距焊盘，不会出现在实物中。

电池接入提供了两种方式，本项目实物中以焊接接入。

![PCB正面](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\PCB正面.png)

![PCB反面](E:\OneDrive - shanghaitech.edu.cn\大学\大三上\基于esp32c3的小键盘\report\PCB反面.png)

#### 可改进

0603太小了，极其考验焊接能力。

type-c的焊接也存在困难。